
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://bartolialberto.github.io/CybersecurityCourse/Authentication%20-%20NTLM%20Kerberos/Authentication%20-%20Windows/">
      
      
        <link rel="prev" href="../../Passwords/Passwords/">
      
      
        <link rel="next" href="../../Lateral%20Movement/AD%20Attack%20Paths/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.1.5">
    
    
      
        <title>Authentication in Windows - Cybersecurity Course - University of Trieste</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.7a7fce14.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-7FK5GG9NWX"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-7FK5GG9NWX",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-7FK5GG9NWX",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="orange" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#authentication-in-windows" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="https://bartoli.inginf.units.it" title="Cybersecurity Course - University of Trieste" class="md-header__button md-logo" aria-label="Cybersecurity Course - University of Trieste" data-md-component="logo">
      
  <img src="../../bernabeu small.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Cybersecurity Course - University of Trieste
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Authentication in Windows
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://bartoli.inginf.units.it" title="Cybersecurity Course - University of Trieste" class="md-nav__button md-logo" aria-label="Cybersecurity Course - University of Trieste" data-md-component="logo">
      
  <img src="../../bernabeu small.png" alt="logo">

    </a>
    Cybersecurity Course - University of Trieste
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Topics/" class="md-nav__link">
        Topics
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          1 - Hacking Lab
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          1 - Hacking Lab
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Hacking%20Lab/Lab_Hacking_Metasploitable/" class="md-nav__link">
        Metasploitable3 Hacking Lab
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Hacking%20Lab/Lab_Virtual_Machines/" class="md-nav__link">
        Metasploitable3 Hacking Lab - Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Hacking%20Lab/Vulnerable%20Platforms/" class="md-nav__link">
        Vulnerable Platforms
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          2 - Access Control
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          2 - Access Control
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Access%20Control/Resources%20-%20Access%20Control/" class="md-nav__link">
        Access Control - Resources
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
      
      
      
        <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
          3 - MITRE ATT&CK
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          3 - MITRE ATT&CK
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../MITRE%20ATTACK/ATTACK%20-%20MITRE/" class="md-nav__link">
        MITRE ATT&CK
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../MITRE%20ATTACK/ICS/" class="md-nav__link">
        ICS - Industrial Control Systems
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
      
      
      
        <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
          4 - Malware
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          4 - Malware
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Malware/Execution%20and%20other%20tactics/" class="md-nav__link">
        Execution and Other Tactics
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Malware/Initial%20Access%20Advanced/" class="md-nav__link">
        Initial Access - Advanced Techniques
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Malware/Initial%20Access/" class="md-nav__link">
        Initial Access
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Malware/Malware%20detection/" class="md-nav__link">
        Malware detection
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Malware/Malware_Case_Studies/" class="md-nav__link">
        Intrusions and Malware - Case studies
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
      
      
      
        <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
          5 - Passwords
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          5 - Passwords
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Passwords/Passwords/" class="md-nav__link">
        Passwords
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
      
      
      
        <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
          6 - Authentication - NTLM Kerberos
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          6 - Authentication - NTLM Kerberos
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Authentication in Windows
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Authentication in Windows
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#windows-protocols" class="md-nav__link">
    Windows Protocols
  </a>
  
    <nav class="md-nav" aria-label="Windows Protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocol-specifications" class="md-nav__link">
    Protocol Specifications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#active-directory-ad" class="md-nav__link">
    Active Directory (AD)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-negotiation" class="md-nav__link">
    Authentication Negotiation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntlm-protocol" class="md-nav__link">
    NTLM Protocol
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-protocol" class="md-nav__link">
    Kerberos Protocol
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntlm-attacks" class="md-nav__link">
    NTLM Attacks
  </a>
  
    <nav class="md-nav" aria-label="NTLM Attacks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pass-the-hash-pth" class="md-nav__link">
    Pass the Hash (PtH)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntlm-relay" class="md-nav__link">
    NTLM Relay
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntlm-relay-coerced-authentication-in-outlook" class="md-nav__link">
    NTLM Relay + Coerced authentication in Outlook
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-attacks" class="md-nav__link">
    Kerberos attacks
  </a>
  
    <nav class="md-nav" aria-label="Kerberos attacks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#finding-good-targets" class="md-nav__link">
    Finding good targets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kerberoasting-and-as-rep-roasting" class="md-nav__link">
    Kerberoasting and AS-REP Roasting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-kerberoasting" class="md-nav__link">
    Detecting Kerberoasting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-does-a-service-account-store-its-password" class="md-nav__link">
    Where does a service account store its password?
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
      
      
      
        <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
          7 - Lateral Movement
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          7 - Lateral Movement
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lateral%20Movement/AD%20Attack%20Paths/" class="md-nav__link">
        AD Attack Paths
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Lateral%20Movement/AD%20Labs%20and%20Tools/" class="md-nav__link">
        AD Attack Examples and Tools
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
      
      
      
        <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
          8 - MFA
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          8 - MFA
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../MFA/MFA/" class="md-nav__link">
        Multifactor Authentication (MFA)
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" >
      
      
      
        <label class="md-nav__link" for="__nav_11" id="__nav_11_label" tabindex="0">
          9 - Memory Corruption
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_11">
          <span class="md-nav__icon md-icon"></span>
          9 - Memory Corruption
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Memory%20Corruption/Memory%20Corruption%20-%20Case%20studies/" class="md-nav__link">
        Memory corruption - Case studies
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Memory%20Corruption/Resources%20-%20Memory%20corruption_/" class="md-nav__link">
        Memory Corruption
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
      
      
      
        <label class="md-nav__link" for="__nav_12" id="__nav_12_label" tabindex="0">
          10 - Vulnerabilities
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_12">
          <span class="md-nav__icon md-icon"></span>
          10 - Vulnerabilities
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Vulnerabilities/Resources%20-%20Vulnerabilities%20Intro/" class="md-nav__link">
        Vulnerabilities Introduction - Resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Vulnerabilities/Resources%20-%20Vulnerability%20Management/" class="md-nav__link">
        Vulnerability Management - Resources
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Vulnerabilities/Vulnerability%20-%20Case%20studies/" class="md-nav__link">
        Vulnerabilities - Case Studies
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
      
      
      
        <label class="md-nav__link" for="__nav_13" id="__nav_13_label" tabindex="0">
          11 - Defense
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_13">
          <span class="md-nav__icon md-icon"></span>
          11 - Defense
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Defense/Defense%20-%20Resources/" class="md-nav__link">
        Defense - Resources
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
      
      
      
        <label class="md-nav__link" for="__nav_14" id="__nav_14_label" tabindex="0">
          Labs
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_14">
          <span class="md-nav__icon md-icon"></span>
          Labs
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Labs/Automated%20Malware%20Analysis/" class="md-nav__link">
        Automated Malware Analysis
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Labs/BURP/" class="md-nav__link">
        BURP
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Labs/MITRE_ATTACK_Navigator/" class="md-nav__link">
        MITRE ATT&CK NAVIGATOR.
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../Labs/OWASP%20Juice%20Shop/" class="md-nav__link">
        OWASP Juice Shop
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../docsify/" class="md-nav__link">
        Report (Docsify-This)
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#windows-protocols" class="md-nav__link">
    Windows Protocols
  </a>
  
    <nav class="md-nav" aria-label="Windows Protocols">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#protocol-specifications" class="md-nav__link">
    Protocol Specifications
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#active-directory-ad" class="md-nav__link">
    Active Directory (AD)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-negotiation" class="md-nav__link">
    Authentication Negotiation
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntlm-protocol" class="md-nav__link">
    NTLM Protocol
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-protocol" class="md-nav__link">
    Kerberos Protocol
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ntlm-attacks" class="md-nav__link">
    NTLM Attacks
  </a>
  
    <nav class="md-nav" aria-label="NTLM Attacks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#pass-the-hash-pth" class="md-nav__link">
    Pass the Hash (PtH)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntlm-relay" class="md-nav__link">
    NTLM Relay
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ntlm-relay-coerced-authentication-in-outlook" class="md-nav__link">
    NTLM Relay + Coerced authentication in Outlook
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#kerberos-attacks" class="md-nav__link">
    Kerberos attacks
  </a>
  
    <nav class="md-nav" aria-label="Kerberos attacks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#finding-good-targets" class="md-nav__link">
    Finding good targets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#kerberoasting-and-as-rep-roasting" class="md-nav__link">
    Kerberoasting and AS-REP Roasting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-kerberoasting" class="md-nav__link">
    Detecting Kerberoasting
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#where-does-a-service-account-store-its-password" class="md-nav__link">
    Where does a service account store its password?
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="authentication-in-windows">Authentication in Windows</h1>
<h2 id="windows-protocols">Windows Protocols</h2>
<h3 id="protocol-specifications">Protocol Specifications</h3>
<ul>
<li>Microsoft <a href="https://learn.microsoft.com/en-us/openspecs/main/ms-openspeclp/3589baea-5b22-48f2-9d43-f5bea4960ddb">specification</a> of ALL the  protocols (more than 600MB compressed): Windows, Office, SQLServer, SharePoint, Exchange.</li>
<li>For <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/MS-WINPROTLP/92b33e19-6fff-496b-86c3-d168206f9845">Windows Protocols</a>, the documentation is split up into:<ul>
<li>Windows Technology Overviews (always start from here)</li>
<li>Windows Technical Specifications</li>
<li>References</li>
</ul>
</li>
</ul>
<h3 id="active-directory-ad">Active Directory (AD)</h3>
<ul>
<li>See LDAP and Active Directory in the <a href="../../Access%20Control/Resources%20-%20Access%20Control/">Access Control section</a></li>
</ul>
<h3 id="authentication-negotiation">Authentication Negotiation</h3>
<p>Out of scope, just to have an idea.</p>
<ul>
<li><a href="https://docs.oracle.com/cd/E37838_01/html/E61050/overview-61.html">Introduction to GSSAPI (Oracle)</a> Generic Security Support API. <a href="https://learn.microsoft.com/en-us/windows-server/security/windows-authentication/security-support-provider-interface-architecture">SSPI Windows Security Support Provider Interface</a> is the Windows GSSAPI implementation.</li>
<li><a href="https://csandker.io/2021/02/21/Offensive-Windows-IPC-2-RPC.html">Offensive Windows IPC Internals 2: RPC</a> Explain in detail how Remote Procedure Calls (RPC) works in Windows. An essential issue in many protocols, including <em>negotiation</em> of the authentication protocol (for <em>downgrading</em> to NTLM when MITM).</li>
<li><a href="https://csandker.io/2018/04/04/SPNEGODown.html">Downgrade SPNEGO Authentication</a> The Windows protocol that client and server use for negotiating authentication, including the reason why a <em>"use Kerberos"</em> offer can be downgraded to <em>"let's use NTLM"</em>.</li>
</ul>
<h2 id="ntlm-protocol">NTLM Protocol</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-nlmp/b38c36ed-2804-4868-a9ff-8dd3182128e4">NT LAN Manager (NTLM) Authentication Protocol</a> The original specification by Microsoft. Extremely complex. Too detailed to be useful (unless you are really an expert working on this very specific topic).</li>
<li><a href="https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4">LM, NTLM, Net-NTLMv2, oh my!</a> Some order in the very confusing terminology of Windows hashes: NTLM hash, NT hash,...</li>
<li><a href="https://www.mike-gualtieri.com/posts/live-off-the-land-and-crack-the-ntlmssp-protocol">Live off the Land and Crack the NTLMSSP Protocol</a> Detailed analysis of the network traffic</li>
</ul>
<h2 id="kerberos-protocol">Kerberos Protocol</h2>
<ul>
<li><a href="https://learn.microsoft.com/en-us/windows/win32/secauthn/microsoft-kerberos?redirectedfrom=MSDN">Microsoft Kerberos</a> All (i.e., too many) details.</li>
<li><a href="https://www.kerberos.org/software/tutorial.html#1.5.1">Kerberos tutorial</a> Very clear and compact. More focussed on the non-Windows version.</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc4120">Kerberos v5 RFC</a>  All (i.e., too many) details.</li>
<li><a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-pac/c38cc307-f3e6-4ed4-8c81-dc550d96223c">Privilege Attribute Certificate (PAC)</a> Many complex details regarding the PAC contained in tickets.</li>
<li><a href="https://www.blackhat.com/docs/us-14/materials/us-14-Duckwall-Abusing-Microsoft-Kerberos-Sorry-You-Guys-Don't-Get-It-wp.pdf">Abusing Kerberos</a> Relatively old but still highly relevant for:<ul>
<li>Salting in Windows Kerberos vs Standard Kerberos</li>
<li>Golden ticket and ticket validation</li>
</ul>
</li>
</ul>
<h2 id="ntlm-attacks">NTLM Attacks</h2>
<ul>
<li><a href="https://csandker.io/2017/09/10/NTLMAuthenticationAWrapUp.html">NTLM Authentication: A Wrap Up</a> Excellent and concise summary, with detailed explanation of:<ul>
<li>offline cracking</li>
<li>pass-the-hash</li>
<li>NTLM relay</li>
</ul>
</li>
</ul>
<h3 id="pass-the-hash-pth">Pass the Hash (PtH)</h3>
<p>As a first approximation, the password hash of an account suffices to impersonate that account, even without knowing the password.</p>
<p>In practice, there are some tricky limitations regarding what can and what cannot be done with a password hash from a remote location. The <a href="https://csandker.io/2017/09/10/NTLMAuthenticationAWrapUp.html#pass-the-hash-pth">Pass the Hash section</a> of the above page summarizes those limitations very well. They are not easy to understand, but it is because they are really tricky; I have not found any clearer summary.</p>
<ul>
<li><a href="https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/lateral-movement/alternate-authentication-material/wip-pass-the-hash">Pass The Hash</a> Excellent summary with lot of examples and screenshots based on many different tools. This specific website (Pentest Everything) is <em>highly recommended</em> because it has many parts structured according to MITRE ATT&amp;CK.</li>
<li><a href="https://www.n00py.io/2020/12/alternative-ways-to-pass-the-hash-pth/">Alternative ways to Pass the Hash (PtH)</a> This is a post on a Windows-focused blog. Very, very good.</li>
</ul>
<h3 id="ntlm-relay">NTLM Relay</h3>
<p>There is a lot of existing material describing techniques and tools for executing NTLM Relay attacks. Such material may be hard to understand when the attack is used as part of a more complex chain, in particular, chains based on advanced Kerberos tricks and/or ACL paths in Active Directory. The links below are generally not based on such complex paths.</p>
<ul>
<li><a href="https://aas-s3curity.gitbook.io/cheatsheet/internalpentest/active-directory/exploitation/exploit-without-account/smb-relay">SMB Relay</a> This page deals with gaining code execution relaying NTLMv1/2 hashes in a very effective manner. Very basic.</li>
<li><a href="https://www.trustedsec.com/blog/a-comprehensive-guide-on-relaying-anno-2022/">I’M BRINGING RELAYING BACK: A COMPREHENSIVE GUIDE ON RELAYING ANNO 2022</a></li>
<li><a href="https://0xdeaddood.rocks/2023/02/28/relaying-everything-coercing-authentications-episode-1-mssql/">Relaying Everything: Coercing Authentications Episode 1 – MSSQL</a></li>
<li>Other relaying examples in the section of this website about <a href="Lateral movement.md">Lateral movement</a>.</li>
</ul>
<h3 id="ntlm-relay-coerced-authentication-in-outlook">NTLM Relay + Coerced authentication in Outlook</h3>
<ul>
<li><a href="https://www.bleepingcomputer.com/news/microsoft/microsoft-fixes-outlook-zero-day-used-by-russian-hackers-since-april-2022/">Microsoft fixes Outlook zero-day used by Russian hackers since April 2022</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-23397">CVE-2023-23397</a></li>
<li><a href="https://www.youtube.com/watch?v=8OtfW4uo75k">Nice video</a> describing how to obtain full domain compromise. It only takes a meeting invite and a user simply opening outlook to exploit this vulnerability. Some details not easy to understand; it requires a bit of knowledge of Active Directory Certificate Services.</li>
<li><a href="https://www.akamai.com/blog/security-research/important-outlook-vulnerability-bypass-windows-api">From One Vulnerability to Another: Outlook Patch Analysis Reveals Important Flaw in Windows API</a> Akamai realized that the patch issued by Microsoft was incorrect and a further patch was needed. Very well written. <a href="https://bartoli-alberto.blogspot.com/2023/05/come-non-pensare-alla-penosa.html">My summary and explanation of this mistake</a> (Italian only).</li>
</ul>
<p><em>Update 2024</em></p>
<ul>
<li><a href="https://www.varonis.com/blog/outlook-vulnerability-new-ways-to-leak-ntlm-hashes">Outlook Vulnerability Discovery and New Ways to Leak NTLM Hashes</a> Varonis Threat Labs discovered a new Outlook vulnerability and three new ways to access NTLM v2 hashed passwords by exploiting Outlook, Windows Performance Analyzer (WPA), and Windows File Explorer.</li>
</ul>
<h2 id="kerberos-attacks">Kerberos attacks</h2>
<h3 id="finding-good-targets">Finding good targets</h3>
<p>Techniques in the <a href="https://attack.mitre.org/tactics/TA0007/">Discovery</a> tactic.</p>
<ul>
<li><a href="https://adsecurity.org/?p=4115">There’s Something About Service Accounts Discover (SPN scanning)</a> Queries for discovering service accounts, accounts that are probably in the Domain Admin group. Description of groups that are often overprivileged and of SPN classes found in manhy environments.</li>
</ul>
<h3 id="kerberoasting-and-as-rep-roasting">Kerberoasting and AS-REP Roasting</h3>
<ul>
<li><a href="https://csandker.io/2017/09/12/KerberosAuthenticationAWrapUp.html">Kerberos Authentication: A Wrap Up</a> Very clear and concise summary of Kerberos, along with a detailed explanation of Kerberoasting and AS-REP Roasting.</li>
<li><a href="https://blog.harmj0y.net/redteaming/kerberoasting-revisited/">Kerberoasting revisited</a>. All you wanted to know about Kerberoasting (and AS-REP Roasting) by harmj0y, an authority on these topics.</li>
<li><a href="https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/decrypting-the-selection-of-supported-kerberos-encryption-types/ba-p/1628797">Decrypting the Selection of Supported Kerberos Encryption Types</a> Decrypting Kerberos RC4 tickets (encryption types 0x17,0x18 dec 23,24) is much faster than decrypting default AES tickets (0x11,0x12 dec 17,18). This is why in roasting attacks RC4 tickets are requested rather than AES tickets.</li>
<li><a href="https://wadcoms.github.io/wadcoms/Impacket-GetNPUsers/">Impacket-GetNPUsers</a> (script GetNPUsers of the Impacket framework) takes a list of usernames, selects those that can be attacked with <em>AS-Rep-Roast</em> and obtain the corresponding domain controller response in a format suitable to John the ripper or Hashcat.</li>
</ul>
<h3 id="detecting-kerberoasting">Detecting Kerberoasting</h3>
<ul>
<li><a href="https://adsecurity.org/?p=3513">Detecting Kerberoasting Activity Part 2 – Creating a Kerberoast Service Account Honeypot</a> This post describes how to filter from millions of events (that could be logged at the Domain Controller) to a single one to detect Kerberoasting activity.</li>
</ul>
<p>Many more Kerberos-based attacks in the section of this website about <a href="Lateral movement.md">Lateral movement</a>.</p>
<h2 id="where-does-a-service-account-store-its-password">Where does a service account store its password?</h2>
<p>There is no user typing that password. The technical details are complex, but the basic idea is not.</p>
<ul>
<li>At boostrap, a high privilege process (SYSTEM or root) creates server processes and associates them with the appropriate service account based on configuration information. The password of the service password is <em>not</em> needed at this point. Such a password is needed when the service account S asks a TGT(S) in Kerberos, i.e., for authenticating to the KDC.</li>
<li>Service passwords are stored in a file that can only be read by a high privilege process (and by the service account itself). This file is usually encrypted.</li>
<li>The key for decrypting this file is (derived from) a <em>master key</em> for the entire computer. In Windows this master key is called SYSKEY and it is the one that, in Kerberos, authenticates the computer account to the KDC. The master key is stored in a file that can only be read by a high privilege process. </li>
<li>An attacker with <em>physical access to the disk</em> will be able to extract the master key for the entire computer.</li>
</ul>
<p>Some technical details are given below, but extracting the basic idea from them is hard.</p>
<ul>
<li><a href="https://web.mit.edu/kerberos/krb5-1.5/krb5-1.5.4/doc/krb5-install/The-Keytab-File.html">The Keytab File</a> Where service keys are stored in MIT Kerberos.</li>
<li><a href="https://medium.com/@browninfosecguy/windows-authentication-and-attacks-101-part-b-e59923697ffb">Windows Authentication and Attacks 101 — Part B</a> A description of how to decrypt password hashes from the SAM (SYSKEY is needed).</li>
<li><a href="https://www.passcape.com/index.php?section=docsys&amp;cmd=details&amp;id=23">Windows LSA secrets</a> LSA secrets is a special protected storage for important data used by the Local Security Authority (LSA) in Windows. LSA is designed for managing a system's local security policy, auditing, authenticating, logging users on to the system, storing private data. Users' and system's sensitive data is stored in secrets. Access to all secret data is available to system only. </li>
<li><a href="https://www.synacktiv.com/publications/windows-secrets-extraction-a-summary">WINDOWS SECRETS EXTRACTION: A SUMMARY</a> Post-exploitation in Windows environments often implies <strong>secrets collection</strong>. The collected secrets can be reused for lateral or vertical movement, making them high value assets. Most people already know the LSASS process, but other secrets such as LSA secrets and DPAPI ones could also allow privilege escalation or access to sensitive resources. This article will describe the different types of secrets that can be found within a Windows machine, and public tools that can be used to retrieve them. </li>
</ul>


  




                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["search.suggest", "search.highlight", "navigation.instant", "navigation.tracking"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.407015b8.min.js"></script>
      
    
  </body>
</html>